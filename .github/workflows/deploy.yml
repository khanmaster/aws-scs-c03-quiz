name: Deploy Quiz Platform

on:
  push:
    branches: [main, dev, qa]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          for file in data/*.json; do
            if [ -f "$file" ]; then
              echo "Validating $file"
              python -m json.tool "$file" > /dev/null
            fi
          done

      - name: Check HTML validity
        run: |
          echo "Checking HTML files..."
          # Basic HTML validation
          for file in *.html; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              # Check for basic HTML structure
              grep -q "<!DOCTYPE html>" "$file" || (echo "Missing DOCTYPE in $file" && exit 1)
              grep -q "<html" "$file" || (echo "Missing html tag in $file" && exit 1)
              grep -q "</html>" "$file" || (echo "Missing closing html tag in $file" && exit 1)
            fi
          done

      - name: Lint JavaScript
        run: |
          echo "Linting JavaScript files..."
          # Basic JS syntax check
          for file in js/*.js; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              node -c "$file"
            fi
          done

      - name: Test question data integrity
        run: |
          echo "Testing question data..."
          python3 << 'EOF'
          import json
          import sys

          try:
              with open('data/questions.json', 'r') as f:
                  data = json.load(f)
              
              questions = data.get('questions', [])
              if not questions:
                  print("No questions found!")
                  sys.exit(1)
              
              for i, q in enumerate(questions):
                  required_fields = ['id', 'type', 'question', 'options', 'correct', 'explanation']
                  for field in required_fields:
                      if field not in q:
                          print(f"Question {i+1} missing field: {field}")
                          sys.exit(1)
                  
                  if q['type'] not in ['single', 'multiple']:
                      print(f"Question {i+1} has invalid type: {q['type']}")
                      sys.exit(1)
                  
                  if not isinstance(q['options'], list) or len(q['options']) < 2:
                      print(f"Question {i+1} needs at least 2 options")
                      sys.exit(1)
              
              print(f"âœ… Validated {len(questions)} questions successfully")
          
          except Exception as e:
              print(f"âŒ Question validation failed: {e}")
              sys.exit(1)
          EOF

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Security scan
        run: |
          echo "Running security checks..."
          
          # Check for sensitive data patterns
          echo "Checking for sensitive patterns..."
          if grep -r -i "password\|secret\|key\|token" --include="*.js" --include="*.html" --include="*.json" . | grep -v "// " | grep -v "<!-- " | grep -v "explanation" | grep -v "keywords" | grep -v "KMS" | grep -v "CMK" | grep -v "IAM" | grep -v "quiz" | grep -v "question" | grep -v "data/questions.json" | grep -v "localStorage" | grep -v "Object.keys" | grep -v "STORAGE_KEYS" | grep -v "get(key)" | grep -v "set(key" | grep -v "remove(key)" | grep -v "KEYWORD_HIGHLIGHT" | grep -v "keyboard" | grep -v "keydown" | grep -v "event.key"; then
            echo "âŒ Potential sensitive data found"
            exit 1
          fi
          
          # Check for hardcoded URLs (except localhost)
          echo "Checking for hardcoded URLs..."
          if grep -r "https\?://" --include="*.js" --include="*.html" . | grep -v "localhost" | grep -v "example.com" | grep -v "github.com"; then
            echo "âš ï¸ Hardcoded URLs found - review for production readiness"
          fi
          
          echo "âœ… Security scan completed"

  deploy:
    needs: [build-and-test, security-scan]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          exclude_assets: '.github,*.md'

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "- **Website URL**: https://khanmaster.github.io/aws-scs-c03-quiz/" >> $GITHUB_STEP_SUMMARY
          echo "- **PWA App**: Visit website â†’ Click 'Install App' button or browser install prompt" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at**: $(date)" >> $GITHUB_STEP_SUMMARY